<!DOCTYPE html>
<html>

  <head>
    <title>Glyphosate Est. 5 Year span </title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">

    <link href="http://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">
    <style>
      body {
        padding: 0;
        margin: 0;
        background: skyblue;
        font-family: Montserrat, serif;
      }

      header,
      footer {
        background: #245574;
        color: white;
        padding: 18px 0;
        box-shadow: 0px 1px 3px #245574;
      }

      form {
        margin: auto;
        width: 50%;
      }

      .container {
        width: 960px;
        margin: 18px auto;
      }

      h1 {
        width: 960px;
        margin: 0 auto;
        font-size: 2em;
      }

      a {
        color: white;
      }

      ul li {
        margin: 0 0 8px 0;
      }

      #map {
        width: 100%;
        height: 600px;
      }


      .state {
        fill: none;
        stroke: red;
        stroke-width: .6;
      }

      .county {
        stroke: grey;
        stroke-width: .3;
      }

      .pest {
        fill: #cf5635;
        stroke: white;
        stroke-width: .3;
        opacity: .8;
      }

      .legend circle {
        fill: none;
        stroke: #ccc;
      }

      .legend text {
        fill: #777;
        font: 10px sans-serif;
        text-anchor: middle;
      }

      .hover {
        stroke: #fe955f;
        stroke-width: 2;
      }

      .tooltip {
        position: absolute;
        min-width: 60px;
        min-height: 28px;
        padding: 6px 12px 3px;
        color: whitesmoke;
        background: #245574;
        border-radius: 2px;
        pointer-events: none;
        opacity: 1;

      }

      .filter {
        position: absolute;
        right: 48px;
        width: 260px;
        font-size: 1.3em;
      }

      /* Legend CSS */

      .axis text {
        font: 10px sans-serif;
      }

      .axis line,
      .axis path {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      #key {
        position: absolute;
        top: 90px;
        left: 50px;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>Select Chemicals 5 Year span</h1>
    </header>
    <div class="container">
      <form>
        <label for="year">Year</label>
        <input type="range" min=1995 max=2015 step=5 id="year" value=1995 oninput="selected_year.value = year.value">
        <output name="selected_year" id="selected_year">2000</output>
      </form>
      <div id="map"></div>
    </div>
    <footer>
      <div class="container">
        <ul>
          <li>Map authored by Gene Hahn</li>
          <li>data sourced from <a href="https://www.census.gov/geo/maps-data/data/tiger-cart-boundary.html">Cartographic Boundary Files</a></li>
          <li>data sourced from <a href="https://water.usgs.gov/nawqa/pnsp/usage/maps/county-level/">USGS Pesticide National Synthesis Project</a></li>
        </ul>
      </div>
      <div class="state">
      </div>
      <div class="county">
        <div> </div>
      </div>
      <div class="tooltip">
        <div> </div>
      </div>
      <div class="tooltip">
        <div> </div>
    </footer>
    <!-- load D3 library -->
    <script src="https://d3js.org/d3.v5.js"></script>

    <!-- load D3 color  -->
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <!-- load TopoJSON -->
    <script src="https://unpkg.com/topojson@3"></script>


    <script>
      // JS code here
      // request the JSON text file, then call drawMap function
      // synchronous calls to data files
      var statesJson = d3.json("data/us-states.json")
      countyJson = d3.json("data/us.json")


      // add chemical Data csv
      var Atrazine = d3.csv("data/atrazine.csv")
      Dicamba = d3.csv("data/dicamba.csv")
      Fomesafen = d3.csv("data/fomesafen.csv")
      Glyphosate = d3.csv("data/glyphosate.csv")
      Paraquat = d3.csv("data/paraquat.csv")
      // chemicals = ["Atrazine", "Dicamba", "Fomesafen", "Glyphosate", "Paraquat"]
      // console.log(year.value)

      // define color generator
      // legend min max range color
      var minimum = 0,
        maximum = 650000;
      var minimumColor = "#fff5f0",
        maximumColor = "#67000d";

      var color = d3.scaleQuantize()
        .domain([0, 56054]) // low and high from the dataset
        .range(d3.schemeYlOrRd[9])
      // console.log("work")
      // use promise to call all data files, then send data to callback
      Promise.all([statesJson, countyJson, Atrazine, Dicamba, Fomesafen, Glyphosate, Paraquat]).then(drawMap, error)
      // function fired if there is an error
      function error(error) {
        console.log(error)
      }


      // draw map
      function drawMap(data) { // drawMap function
        // data is array of our 7 datasets
        var statesData = data[0],
          countyData = data[1],
          chemicals = ["Atrazine", "Dicamba", "Fomesafen", "Glyphosate", "Paraquat"]

        // console.log(countyData)

        var lowValue = Infinity,
          highValue = 0;


        var color = d3.scaleQuantize()
          .domain([.1, 56054]) // low and high from the dataset
          .range(d3.schemeYlOrRd[9])

        var stateBrdy = svg.append("g")
          .selectAll("path") // select all the paths (that don't exist yet)
          .data(geojsonState.features) // use the GeoJSON data
          .enter() // enter the selection
          .append("path") // append new path elements for each data feature
          .attr("d", path) // give each path a d attribute value
          .attr("class", "state") // give each path a class of sate


        // Create  div for the tooltip and hide with opacity
        var tooltip = d3.select("path").append("div")
          .attr("class", "tooltip")

        // add polygon to map pestCSV --can stack layers with order in code


        // Create  div for the tooltip and hide with opacity
        var tooltip = d3.select("body").append("div")
          .attr("class", "tooltip")

        // select the map element
        d3.select("#map")
          .on("mousemove", function(event) { // when mouse moves over it
            // update the position of the tooltip
            tooltip.style("left", (d3.event.pageX + 10) + "px")
              .style("top", (d3.event.pageY - 30) + "px");
          })
        // console.log(pestData)
        addFilter(chemicals)
        addLegend(minimum, maximum, minimumColor, maximumColor, color)
      }

      function addFilter(chemicals) { // START addFilter function
        // select the map element
        var dropdown = d3.select('#map')
          .append('select') // append a new select element
          .attr('class', 'filter') // add a class name
          .on('change', onchange) // listen for change
        // select all the options (that don't exist yet)
        dropdown.selectAll('option')
          .data(chemicals).enter() // attach our array as data
          .append("option") // append a new option element for each data item
          .text(function(d) {

            return d // use the item as text
          })
        var geojsonCounty = topojson.feature(countyData, {
          type: "GeometryCollection",
          geometries: countyData.objects.cb_2017_us_county_500k.geometries
        })
        // define a projection using the US Albers USA
        // fit the extent of the GeoJSON data to specified
        // width and height
        // Alberts projection
        var projection = d3.geoAlbersUsa()
          .fitSize([width, height], geojsonState)

        // define a path generator, which will use
        // the specified projection
        var path = d3.geoPath()
          .projection(projection)


        // console.log(year.value)
        // create and append a new SVG g element to the SVG
        var countyBrdy = svg.append("g")
          .selectAll("path") // select all the paths (that don't exist yet)
          .data(geojsonCounty.features) // use the GeoJSON data
          .enter() // enter the selection
          .append("path") // append new path elements for each data feature
          .attr("d", path) // give each path a d attribute value
          .attr("class", "county") // give each path a class of sate
          .attr('fill', function(d) {
            if (d.properties.Atrazine) {
              // console.log(d.properties.pestData[year.value])
              return color(+d.properties.Atrazine[year.value]);
            }
          })

          .on("mouseover", function(d) { // when mousing over an element
            // console.log(d)
            d3.select(this).classed("hover", true).raise(); // select it, add a class name, and bring to front
            tooltip.style("opacity", 1).html(d.properties.Atrazine.co_name + ", " + d.properties.Atrazine.st_name +
              "<br>" + d.properties.Atrazine[year.value] + " kg") // make tooltip visible and update info
          })

          .on("mouseout", function() { // when mousing out of an element
            d3.select(this).classed("hover", false) // remove the class
            tooltip.style("opacity", 0) // hide the element
          })

        var stateBrdy = svg.append("g")
          .selectAll("path") // select all the paths (that don't exist yet)
          .data(geojsonState.features) // use the GeoJSON data
          .enter() // enter the selection
          .append("path") // append new path elements for each data feature
          .attr("d", path) // give each path a d attribute value
          .attr("class", "state") // give each path a class of sate
        // .text(function(d) {
        //   return d.properties.STUSPS;
        // })
        // console.log(d)
        // .attr("x", function(d) {
        //   return path.centroid(d)[0];
        // })
        // .attr("y", function(d) {
        //   return path.centroid(d)[1];
        // })
        // .attr("text-anchor", "middle")
        // .attr('font-size', '20pt');

        // Create  div for the tooltip and hide with opacity
        var tooltip = d3.select("path").append("div")
          .attr("class", "tooltip")

        // add polygon to map pestCSV --can stack layers with order in code


        // Create  div for the tooltip and hide with opacity
        var tooltip = d3.select("body").append("div")
          .attr("class", "tooltip")

        // select the map element
        d3.select("#map")
          .on("mousemove", function(event) { // when mouse moves over it
            // update the position of the tooltip
            tooltip.style("left", (d3.event.pageX + 10) + "px")
              .style("top", (d3.event.pageY - 30) + "px");
          })
        // console.log(pestData)

        // bind csv data to county
        bind(data, chemicals, countyData)
        addFilter(chemicals)
        addLegend(minimum, maximum, minimumColor, maximumColor, color)
      }

      function addFilter(chemicals) { // START addFilter function
        // select the map element
        var dropdown = d3.select('#map')
          .append('select') // append a new select element
          .attr('class', 'filter') // add a class name
          .on('change', onchange) // listen for change
        // select all the options (that don't exist yet)
        dropdown.selectAll('option')
          .data(chemicals).enter() // attach our array as data
          .append("option") // append a new option element for each data item
          .text(function(d) {

            return d // use the item as text
          })
          .attr("value", function(d) {
            // console.log(d.value)
            return d // use the time as value attribute
          })

        function onchange() { // START onChange
          // get the current value from the select element
          var val = d3.select('select').property('value')
          console.log(val)
        } //END onChange
      } // END addFilter function

      function addLegend(minimum, maximum, minimumColor, maximumColor, color) { //START addLegend function
        var w = 140,
          h = 600;

        var key = d3.select("body").append("svg").attr("id", "key").attr("width", w).attr("height", h);

        var legend = key.append("defs").append("svg:linearGradient").attr("id", "gradient").attr("x1", "100%").attr("y1", "0%").attr("x2", "100%").attr("y2", "100%").attr("spreadMethod", "pad");

        legend.append("stop").attr("offset", "0%").attr("stop-color", maximumColor).attr("stop-opacity", 1);

        legend.append("stop").attr("offset", "100%").attr("stop-color", minimumColor).attr("stop-opacity", 1);

        key.append("rect").attr("width", w - 100).attr("height", h - 100).style("fill", "url(#gradient)").attr("transform", "translate(0,65)");

        var y = d3.scaleLinear().range([565, 65]).domain([minimum, maximum]);

        var yAxis = d3.axisRight(y);

        key.append("g").attr("class", "y axis").attr("transform", "translate(42,0)").call(yAxis)
          .append("text").attr("transform", "rotate(-90)").attr("y", 45).attr("dy", ".71em").style("text-anchor", "end").text(
            "kg per County");
      } //END addLEgend function

      // calculate lbs per Acre per county
      function calLbs(lbsAc) { // START calLbs function
        var lbs = ((lbsAc[year.value] * 2.2046226218) / lbsAc.aland_ac)
        return lbs
      } //END calLbs function

      function bind(data, chemicals, countyData) { // START bind function
        for (i = 0; i < chemicals.length; i++) {
          countyData.objects.cb_2017_us_county_500k.geometries.forEach(function(county) {
            data[i + 2].forEach(function(each) {
              if (county.properties.GEOID == each.geoid) {
                county.properties[chemicals[i]] = each
                return
              }
            })
          });
        } // END bind function
      }
    </script>
  </body>

</html>